<!DOCTYPE html>
<html>
<head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>Emotion Journal</title>
        <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="card">
        <h1 class="title">Emotion Journal</h1>
        <p class="subtitle">Write a short entry and either analyze it (mocked) or save it to your history.</p>

        <label class="sr" for="entry-text">Journal entry</label>
        <textarea id="entry-text" placeholder="Write about your day..." ></textarea>

        <div class="actions">
            <button class="btn" id="analyze-btn">Analyze</button>
                    <form class="save-form" action="/add" method="POST">
                        <input type="hidden" name="emotion" id="save-emotion" value="">
                        <input type="hidden" name="note" id="save-note" value="">
                        <input type="hidden" name="stress" id="save-stress" value="">
                        <button class="btn secondary" type="submit" id="save-btn">Save entry</button>
                    </form>
            <a class="btn secondary" href="/history">View history</a>
        </div>

        <div id="result" style="margin-top:16px; display:none">
            <div class="reflection" id="reflection"></div>
            <div class="chips" id="chips"></div>
            <div class="stress">
                <div class="score muted">Stress level</div>
                <div class="bar" id="stress-bar" style="--val:0%"></div>
            </div>
        </div>

        <p class="footnote">Tip: use Analyze to preview the detection before saving.</p>
    </div>

    <script>
        async function analyzeText(text){
            const res = await fetch('/analyze', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ text })
            });
            return res.json();
        }

        document.getElementById('analyze-btn').addEventListener('click', async function(e){
            e.preventDefault();
            const text = document.getElementById('entry-text').value.trim();
            if(!text){ alert('Please write a short entry to analyze.'); return }
            const out = await analyzeText(text);
            // populate result
            document.getElementById('result').style.display = 'block';
            document.getElementById('reflection').textContent = out.reflection || '';
            const chips = document.getElementById('chips');
            chips.innerHTML = '';
            const emoChip = document.createElement('div');
            emoChip.className = 'chip chip-dominant';
            emoChip.textContent = (out.emotion || 'neutral').toUpperCase();
            chips.appendChild(emoChip);
            (out.keywords || []).slice(0,6).forEach(k=>{
                const c = document.createElement('div'); c.className='chip'; c.textContent = k; chips.appendChild(c);
            });
            // stress
            const stress = Math.max(0, Math.min(100, out.stress || 0));
            document.getElementById('stress-bar').style.setProperty('--val', stress + '%');

            // set hidden save fields so user can save the analyzed emotion/note/stress
            document.getElementById('save-emotion').value = out.emotion || '';
            document.getElementById('save-note').value = text;
            document.getElementById('save-stress').value = out.stress || '';
        });
    </script>
</body>
</html>
